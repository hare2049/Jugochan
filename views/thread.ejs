<!DOCTYPE html>
<html>
  <head>
    <title><%= title %></title>
    <link rel='stylesheet' href='/stylesheets/thread.css' />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body>
    <div id="navbarTop"><span class="boardList">/<a>b</a>/<a>lit</a>/<a>tv</a>/<a>mu</a>/<a>pol</a>/</span><span class="navbarRight">[<a>Options</a>]</span></div>
    <div style="border: 1px solid green">
      <a id="reply_link">Odgovori</a>
      <form id="reply_form" action="/b/reply" method="post" enctype="multipart/form-data">
        <input name="thread_id" type="hidden" value="<%=thread.id%>">
        <table>
          <tbody>
          <tr>
            <td class="labels">
              Username
            </td>
            <td>
              <input name="username" type="text">
              <button type="submit">Objavi</button>
            </td>
          </tr>
          <tr>
            <td class="labels">
              Tekst
            </td>
            <td style="display: flex; flex-wrap: wrap; flex-direction: column;">
              <textarea name="text" id="text" cols="36" rows="4" wrap="soft"></textarea>
            </td>
          </tr>
          <tr>
            <td class="labels">
              File
            </td>
            <td>
              <input name="uploaded_file" id="file" type="file">
            </td>
          </tr>
          </tbody>
        </table>
      </form>
    </div>

    <div id="<%= thread.id %>" style="border: 1px solid red">
      <input type="checkbox" id="ch<%=thread.id%>" value="t-<%=thread.id%>">
      <span id="thread_subject"><%=thread.thread_topic %></span>
      <span id="thread_username"><b><%=thread.username%></b> <%if(thread.tripcode != null){%><%='!' + thread.tripcode%><%}%></span>
      <span id="thread_time"><%=thread.created_at %></span>
      <a id="thread_id" data-id="<%=thread.id%>" onclick="formPopUp(this)"><%=thread.id%></a>
      <p id="thread_text"><%=thread.text%></p>
    </div>
    <%let repliesNumber = replies.length;%>

    <% for (let i = 0; i < replies.length; i++) { %>
      <div id="<%= replies[i].id %>" style="border: 1px solid blue">
        <input type="checkbox" id="ch<%=replies[i].id%>" value="<%=replies[i].id%>" data-cookie="<%=replies[i].cookie%>">
        <span id="reply_username<%=replies[i].id%>"><b><%=replies[i].username%></b> <%if(replies[i].tripcode != null){%><%='!' + replies[i].tripcode%><%}%></span>
        <span id="reply_time<%=replies[i].id%>"><%=replies[i].created_at %></span>
        <a id="reply_id<%=replies[i].id%>" data-id="<%=replies[i].id%>" onclick="formPopUp(this)"><%=replies[i].id%></a>
        <pre id="reply_text<%=i%>"><%=replies[i].text%></pre>
      </div>
    <% } %>

    <form id="floating_reply_form" class="draggable" action="/b/reply" method="post" enctype="multipart/form-data">
      <div id="draggable_header">Odgovori <img id="draggable_header_x" style="float: right" alt="X" src="/images/cross.png"></div>
      <input name="thread_id" type="hidden" value="<%=thread.id%>">
      <table>
        <tbody>
          <tr>
            <td>
              <input name="username" id="floating_username" type="text" placeholder="Username">
            </td>
          </tr>
          <tr>
            <td style="display: flex; flex-wrap: wrap; flex-direction: column;">
              <textarea name="text" id="floating_text" cols="36" rows="4" wrap="soft" placeholder="Tekst"></textarea>
            </td>
          </tr>
        </tbody>
      </table>
      <div>
        <input name="uploaded_file" id="file" type="file" style="width: 180px">
        <button id="floating_submit" type="submit" style="width: 75px; height: 21px; float: right">Objavi</button>
      </div>
    </form>

    <a id="floating_reply_bottom">Reply</a>
    <a id="delete">Delete</a>
    <a id="OptionsLink">Options</a>

    <script>
      let colored = false;
      function hoverpreview(anchor){
        console.log(anchor);
        let targetID = parseInt(anchor.innerHTML.match(/\d+/)[0]);
        let targetDiv = document.getElementById(targetID);

        let bounding = targetDiv.getBoundingClientRect();

        // Check if the element is in the viewport
        if (
          bounding.top >= 0 &&
          bounding.left >= 0 &&
          bounding.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
          bounding.right <= (window.innerWidth || document.documentElement.clientWidth)
        ) {
          // If the element is in the viewport, change its background color to red
          targetDiv.style.backgroundColor = "red";
          colored = true;
        } else {
          console.log('u elsu')
          colored = false;

          console.log(anchor.offsetLeft);
          console.log(anchor.offsetTop);

          let previewDiv = targetDiv.cloneNode(true);
                  //document.createElement('div');
          /*
          previewDiv.innerText = targetDiv.innerText;
          previewDiv.style.position = 'absolute';
          previewDiv.style.top = (event.clientY + 10) + 'px';
          previewDiv.style.left = (event.clientX + 10) + 'px';
           */
          previewDiv.style.left =  anchor.offsetLeft + 50 + "px";
          previewDiv.style.top = anchor.offsetTop +"px";
          previewDiv.style.position = "absolute";

          previewDiv.removeAttribute('id');
          document.body.appendChild(previewDiv);



          // Remove preview div when mouse leaves
          anchor.addEventListener('mouseleave', function() {
            console.log('tu smo');
            previewDiv.parentNode.removeChild(previewDiv);
          });
        }
      }
      function hoverleave(anchor){
        let targetID = parseInt(anchor.innerHTML.match(/\d+/)[0]);
        let targetDiv = document.getElementById(targetID);
        if(colored) targetDiv.style.backgroundColor = "white";
      }
      let repliesNumberS;
      repliesNumberS = '<%=repliesNumber%>';
      let threadID = document.getElementById('thread_id').getAttribute('data-id');

      for(let i = 0; i < repliesNumberS; i++){
        let replyBody = document.getElementById('reply_text' + i);
        let replyText = replyBody.innerText;
        let regex = />>(\d+)/g;
        let matches = replyText.match(regex)
        if (matches === null) continue;
        let tags = matches.map(match => match.replace(/>>/g, ''));
        let session_id = decodeURIComponent(document.cookie.slice('session_id='.length));
        let replySession;
        let specificEx;


        for(let j = 0; j < tags.length; j++){
          if(tags[j] !== threadID){
            if(document.getElementById('ch'+ tags[j]) == null) {
              replySession = null
            }
            else replySession = document.getElementById('ch' + tags[j]).getAttribute('data-cookie');
          }

          specificEx = new RegExp(">>(" + tags[j] + ")", "g");



          if(tags[j] === threadID){
            replyText = replyText.replace(specificEx, `<a onmouseover="hoverpreview(this)" onmouseleave="hoverleave(this)" href="#$1">>>$1(OP)</a>`)

          }
          else if(session_id === replySession){
            replyText = replyText.replace(specificEx, '<a onmouseover="hoverpreview(this)" onmouseleave="hoverleave(this)" href="#$1">>>$1(Ti)</a>')
          }
          else{
            replyText = replyText.replace(specificEx, '<a onmouseover="hoverpreview(this)" onmouseleave="hoverleave(this)" href="#$1">>>$1</a>')
          }
        }
        replyBody.innerHTML = replyText;
      }
    </script>
    <script src="/javascripts/options.js"></script>
    <script src="/javascripts/delete.js"></script>
    <script src="/javascripts/reply_form.js"></script>
    <script src="/javascripts/security_form_check.js"></script>
  </body>
</html>
